<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/cr-styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <p id="logo">ADMIN</p>
            <a href="/admin">สินค้า</a>
        </div>
        <div class="nav-right">
            <a class="fa-regular fa-user icon" onclick="logout(event)"></a>
        </div>
    </nav>

    <div class="container">
        <h2>แก้ไขสินค้า: <%= product.name %></h2>
        
        <form id="productForm" action="/admin/products/<%= product.product_id %>">
            
            <label for="productName">ชื่อสินค้า</label>
            <input type="text" id="productName" name="name" value="<%= product.name %>" required>

            <label for="price">ราคาสินค้า</label>
            <input type="number" id="price" name="price" value="<%= product.price %>" required>

            <label for="description">คำอธิบายสินค้า</label>
            <textarea id="description" name="description"><%= product.description %></textarea>

            <label for="category">หมวดหมู่</label>
            <select id="category" name="category_id">
                <option value="1" <%= product.category_id == 1 ? 'selected' : '' %>>เสื้อยืด</option>
                <option value="2" <%= product.category_id == 2 ? 'selected' : '' %>>แจ็กเกต</option>
                <option value="3" <%= product.category_id == 3 ? 'selected' : '' %>>เสื้อโค้ท</option>
                <option value="4" <%= product.category_id == 4 ? 'selected' : '' %>>กางเกงขายาว</option>
                <option value="5" <%= product.category_id == 5 ? 'selected' : '' %>>กางเกงยีน</option>
            </select>
            
            <label for="color">สี</label>
            <select id="color" name="color">
                <option value="Black" <%= product.color == 'Black' ? 'selected' : '' %>>สีดำ</option>
                <option value="White" <%= product.color == 'White' ? 'selected' : '' %>>สีขาว</option>
                <option value="Brown" <%= product.color == 'Brown' ? 'selected' : '' %>>สีน้ำตาล</option>
                <option value="Grey" <%= product.color == 'Grey' ? 'selected' : '' %>>สีเทา</option>
            </select>

            <label for="gender">เพศ</label>
            <select id="gender" name="gender">
                <option value="2" <%= product.gender == 2 ? 'selected' : '' %>>ผู้ชาย</option>
                <option value="1" <%= product.gender == 1 ? 'selected' : '' %>>ผู้หญิง</option>
            </select>

            <hr>
            <label>รูปภาพปัจจุบัน</label>
            <img src="<%= product.image_url %>" alt="Current Image" style="max-width: 200px; display: block; margin-bottom: 10px;">
            
            <label for="imageFile">รูปภาพใหม่ </label>
            <input type="file" id="imageFile" name="image">

            <button type="submit">บันทึกการแก้ไข</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const productForm = document.getElementById('productForm');

    productForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        // [เพิ่ม] 1. ดึงปุ่ม Submit
        const submitButton = productForm.querySelector('button[type="submit"]');
        
        const formData = new FormData(productForm);
        const actionUrl = productForm.action;
        const categorySelect = document.getElementById("category");
        const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
        formData.append('categories', categoryName);
        
        try {
            // [เพิ่ม] 2. ปิดการใช้งานปุ่มและเปลี่ยนข้อความ
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            const response = await fetch(actionUrl, {
                method: 'PUT',
                body: formData,
            });

            const result = await response.json();

            if (response.ok) {
                alert("อัปเดตสินค้าสำเร็จ!");
                window.location.href = "/admin";
            } else {
                alert("อัปเดตสินค้าล้มเหลว: " + result.message);
            }
        } catch (error) {
            console.error("เกิดข้อผิดพลาดในการส่งข้อมูล:", error);
            alert("เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์");
        } finally {
            // [เพิ่ม] 3. เปิดการใช้งานปุ่มอีกครั้ง
            submitButton.disabled = false;
            submitButton.textContent = 'บันทึกการแก้ไข';
        }
    });
});

        function logout(event) {
            event.preventDefault();
            const confirmLogout = confirm("คุณต้องการออกจากระบบหรือไม่ ?");
            if (confirmLogout) { window.location.href = "/signout"; }
        }
    </script>
</body>
</html>